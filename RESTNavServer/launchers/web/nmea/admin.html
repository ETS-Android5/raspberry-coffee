<!DOCTYPE html>
<!--
 | This is an example illustrating the way to use the
 | REST API provided to administer the NMEA Multiplexer
 | Provided "as is".
 | The main goal is to have something LIGHT!
 | It needs to run fine, even on small boards like the Raspberry Pi Zero,
 | and for now, it does.
 |
 | Also see mux.rest.js. It contains some logic associated with this dashboard.
 +-->
<html>
  <head>
    <title>NMEA Multiplexer Admin</title>

    <!--link rel="icon" type="image/ico" href="icons/ajax.ico"-->
    <link rel="icon" type="image/jpg" href="../icons/palm.04.jpg">

    <script type="text/javascript" src="../js/jquery-2.1.3.js"></script>
    <script type="text/javascript" src="../js/pub.sub.js"></script>
    <script type="text/javascript" src="../js/mux.rest.js"></script>
    <script type="text/javascript" src="../widgets/Graph.js"></script>
    <link id="page-ux" rel="stylesheet" href="../css/stylesheet.css" type="text/css"/>
    <style>
      .selectedButton {
        padding: 5px;
        border-top-right-radius: 10px;
        border: 1px solid #CCC;
        margin-top: 10px;
        border-bottom: none;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
      }
      .unselectedButton {
        padding: 5px;
        border-top-right-radius: 10px;
        border: 1px solid #CCC;
        margin-top: 10px;
        border-bottom: none;
        font-size: 12px;
        font-weight: normal;
        cursor: pointer;
      }
      .addbox {
        padding: 1px;
        border-radius: 5px;
        border: 1px solid #CCC;
        width: auto;
        height: auto;
        margin: 80px auto 0px auto;
        overflow: auto;
      }

      th, td {
         border: 1px solid #CCC;
         border-radius: 5px;
         padding: 3px;
      }

      canvas {
        width: 100%;
        height: 100px;
      }

    </style>
    <link id="graph-ux" rel="stylesheet" href="../css/graph.ux.01.css" type="text/css"/>
    <script type="text/javascript">

        var cssSelectManager = function() {
            var x = document.getElementById("css-select").value;
            var css = document.getElementById("page-ux");
            var cssName = "../css/" + x;
            css.href =  cssName;
        };
        var graphCssSelectManager = function() {
            var x = document.getElementById("graph-css-select").value;
            var css = document.getElementById("graph-ux");
            var cssName = "../css/" + x;
            css.href =  cssName;
            // Broadcast the event, for reload of the css by the component.
            events.publish('color-scheme-changed', cssName); // Name is not used...
        };

        /**
         * Displays the errors in a non-modal way.
         * @param mess the error message to display.
         */
        var errorHandler = function(mess) {
          var messZone = document.getElementById("err-mess");
          messZone.innerText = mess;
          setTimeout(function() {
              messZone.innerText = "";
          }, 10000);
        };

        // Executed at startup
        (function () {
            errManager.display = errorHandler; // in mux.rest.js
        })();

        var channelSelectManager = function() {
            var x = document.getElementById("channel-select").value;
            manageChannelSelection(x);
        };

        var forwardSelectManager = function() {
            var x = document.getElementById("forwarder-select").value;
            manageForwardSelection(x);
        };

        var computerSelectManager = function() {
            var x = document.getElementById("computer-select").value;
            manageComputerSelection(x);
        };

        var showRESTData = false;
        var showHideRESTData = function() {
            showRESTData = !showRESTData;
      //    $("#raw-data-div").css('display', showRESTData ? 'block' : 'none');
            if (showRESTData) {
              $("#raw-data-div").show(1000);
            } else {
              $("#raw-data-div").hide(1000);
            }

            $("#show-hide-raw-data").html(showRESTData ? "<small>&nbsp;<img src='pandown.gif'> Hide REST Traffic</small>" : "<small>&nbsp;<img src='panright.gif'> Show REST Traffic</small>");
        };

        var manageChannelSelection = function(selected) {
            switch (selected) {
                case 'serial':
                    $("#channel-serial").css('display', 'inline');
                    $("#channel-tcp").css('display', 'none');
                    $("#channel-file").css('display', 'none');
                    $("#channel-ws").css('display', 'none');
                    $("#channel-rnd").css('display', 'none');
                    $("#channel-bmp180").css('display', 'none');
                    $("#channel-bme280").css('display', 'none');
                    $("#channel-lsm303").css('display', 'none');
                    $("#channel-htu21df").css('display', 'none');
                    $("#channel-zda").css('display', 'none');
                    $("#channel-custom").css('display', 'none');
                    break;
                case 'tcp':
                    $("#channel-serial").css('display', 'none');
                    $("#channel-tcp").css('display', 'inline');
                    $("#channel-file").css('display', 'none');
                    $("#channel-ws").css('display', 'none');
                    $("#channel-rnd").css('display', 'none');
                    $("#channel-bmp180").css('display', 'none');
                    $("#channel-bme280").css('display', 'none');
                    $("#channel-lsm303").css('display', 'none');
                    $("#channel-htu21df").css('display', 'none');
                    $("#channel-zda").css('display', 'none');
                    $("#channel-custom").css('display', 'none');
                    break;
                case 'file':
                    $("#channel-serial").css('display', 'none');
                    $("#channel-tcp").css('display', 'none');
                    $("#channel-file").css('display', 'inline');
                    $("#channel-ws").css('display', 'none');
                    $("#channel-rnd").css('display', 'none');
                    $("#channel-bmp180").css('display', 'none');
                    $("#channel-bme280").css('display', 'none');
                    $("#channel-lsm303").css('display', 'none');
                    $("#channel-htu21df").css('display', 'none');
                    $("#channel-zda").css('display', 'none');
                    $("#channel-custom").css('display', 'none');
                    break;
                case 'ws':
                    $("#channel-serial").css('display', 'none');
                    $("#channel-tcp").css('display', 'none');
                    $("#channel-file").css('display', 'none');
                    $("#channel-ws").css('display', 'inline');
                    $("#channel-rnd").css('display', 'none');
                    $("#channel-bmp180").css('display', 'none');
                    $("#channel-bme280").css('display', 'none');
                    $("#channel-lsm303").css('display', 'none');
                    $("#channel-htu21df").css('display', 'none');
                    $("#channel-zda").css('display', 'none');
                    $("#channel-custom").css('display', 'none');
                    break;
                case 'rnd':
                    $("#channel-serial").css('display', 'none');
                    $("#channel-tcp").css('display', 'none');
                    $("#channel-file").css('display', 'none');
                    $("#channel-ws").css('display', 'none');
                    $("#channel-rnd").css('display', 'inline');
                    $("#channel-bmp180").css('display', 'none');
                    $("#channel-bme280").css('display', 'none');
                    $("#channel-lsm303").css('display', 'none');
                    $("#channel-htu21df").css('display', 'none');
                    $("#channel-zda").css('display', 'none');
                    $("#channel-custom").css('display', 'none');
                    break;
                case 'bmp180':
                    $("#channel-serial").css('display', 'none');
                    $("#channel-tcp").css('display', 'none');
                    $("#channel-file").css('display', 'none');
                    $("#channel-ws").css('display', 'none');
                    $("#channel-rnd").css('display', 'none');
                    $("#channel-bmp180").css('display', 'inline');
                    $("#channel-bme280").css('display', 'none');
                    $("#channel-lsm303").css('display', 'none');
                    $("#channel-htu21df").css('display', 'none');
                    $("#channel-zda").css('display', 'none');
                    $("#channel-custom").css('display', 'none');
                    break;
                case 'bme280':
                    $("#channel-serial").css('display', 'none');
                    $("#channel-tcp").css('display', 'none');
                    $("#channel-file").css('display', 'none');
                    $("#channel-ws").css('display', 'none');
                    $("#channel-rnd").css('display', 'none');
                    $("#channel-bmp180").css('display', 'none');
                    $("#channel-bme280").css('display', 'inline');
                    $("#channel-lsm303").css('display', 'none');
                    $("#channel-htu21df").css('display', 'none');
                    $("#channel-zda").css('display', 'none');
                    $("#channel-custom").css('display', 'none');
                    break;
                case 'lsm303':
                    $("#channel-serial").css('display', 'none');
                    $("#channel-tcp").css('display', 'none');
                    $("#channel-file").css('display', 'none');
                    $("#channel-ws").css('display', 'none');
                    $("#channel-rnd").css('display', 'none');
                    $("#channel-bmp180").css('display', 'none');
                    $("#channel-bme280").css('display', 'none');
                    $("#channel-lsm303").css('display', 'inline');
                    $("#channel-htu21df").css('display', 'none');
                    $("#channel-zda").css('display', 'none');
                    $("#channel-custom").css('display', 'none');
                    break;
                case 'htu21df':
                    $("#channel-serial").css('display', 'none');
                    $("#channel-tcp").css('display', 'none');
                    $("#channel-file").css('display', 'none');
                    $("#channel-ws").css('display', 'none');
                    $("#channel-rnd").css('display', 'none');
                    $("#channel-bmp180").css('display', 'none');
                    $("#channel-bme280").css('display', 'none');
                    $("#channel-lsm303").css('display', 'none');
                    $("#channel-htu21df").css('display', 'inline');
                    $("#channel-zda").css('display', 'none');
                    $("#channel-custom").css('display', 'none');
                    break;
                case 'zda':
                    $("#channel-serial").css('display', 'none');
                    $("#channel-tcp").css('display', 'none');
                    $("#channel-file").css('display', 'none');
                    $("#channel-ws").css('display', 'none');
                    $("#channel-rnd").css('display', 'none');
                    $("#channel-bmp180").css('display', 'none');
                    $("#channel-bme280").css('display', 'none');
                    $("#channel-lsm303").css('display', 'none');
                    $("#channel-htu21df").css('display', 'none');
                    $("#channel-zda").css('display', 'inline');
                    $("#channel-custom").css('display', 'none');
                    break;
                case 'custom':
                    $("#channel-serial").css('display', 'none');
                    $("#channel-tcp").css('display', 'none');
                    $("#channel-file").css('display', 'none');
                    $("#channel-ws").css('display', 'none');
                    $("#channel-rnd").css('display', 'none');
                    $("#channel-bmp180").css('display', 'none');
                    $("#channel-bme280").css('display', 'none');
                    $("#channel-lsm303").css('display', 'none');
                    $("#channel-htu21df").css('display', 'none');
                    $("#channel-zda").css('display', 'none');
                    $("#channel-custom").css('display', 'inline');
                    break;
                default:
                    break;
            }
        };

        var manageForwardSelection = function(selected) {
            switch (selected) {
                case 'serial':
                    $("#forward-serial").css('display', 'inline');
                    $("#forward-tcp").css('display', 'none');
                    $("#forward-gpsd").css('display', 'none');
                    $("#forward-rmi").css('display', 'none');
                    $("#forward-file").css('display', 'none');
                    $("#forward-ws").css('display', 'none');
                    $("#forward-console").css('display', 'none');
                    $("#forward-custom").css('display', 'none');
                    break;
                case 'tcp':
                    $("#forward-serial").css('display', 'none');
                    $("#forward-tcp").css('display', 'inline');
                    $("#forward-gpsd").css('display', 'none');
                    $("#forward-rmi").css('display', 'none');
                    $("#forward-file").css('display', 'none');
                    $("#forward-ws").css('display', 'none');
                    $("#forward-console").css('display', 'none');
                    $("#forward-custom").css('display', 'none');
                    break;
                case 'gpsd':
                    $("#forward-serial").css('display', 'none');
                    $("#forward-tcp").css('display', 'none');
                    $("#forward-gpsd").css('display', 'inline');
                    $("#forward-rmi").css('display', 'none');
                    $("#forward-file").css('display', 'none');
                    $("#forward-ws").css('display', 'none');
                    $("#forward-console").css('display', 'none');
                    $("#forward-custom").css('display', 'none');
                    break;
                case 'rmi':
                    $("#forward-serial").css('display', 'none');
                    $("#forward-tcp").css('display', 'none');
                    $("#forward-gpsd").css('display', 'none');
                    $("#forward-rmi").css('display', 'inline');
                    $("#forward-file").css('display', 'none');
                    $("#forward-ws").css('display', 'none');
                    $("#forward-console").css('display', 'none');
                    $("#forward-custom").css('display', 'none');
                    break;
                case 'file':
                    $("#forward-serial").css('display', 'none');
                    $("#forward-tcp").css('display', 'none');
                    $("#forward-gpsd").css('display', 'none');
                    $("#forward-rmi").css('display', 'none');
                    $("#forward-file").css('display', 'inline');
                    $("#forward-ws").css('display', 'none');
                    $("#forward-console").css('display', 'none');
                    $("#forward-custom").css('display', 'none');
                    break;
                case 'ws':
                    $("#forward-serial").css('display', 'none');
                    $("#forward-tcp").css('display', 'none');
                    $("#forward-gpsd").css('display', 'none');
                    $("#forward-rmi").css('display', 'none');
                    $("#forward-file").css('display', 'none');
                    $("#forward-ws").css('display', 'inline');
                    $("#forward-console").css('display', 'none');
                    $("#forward-custom").css('display', 'none');
                    break;
                case 'console':
                    $("#forward-serial").css('display', 'none');
                    $("#forward-tcp").css('display', 'none');
                    $("#forward-gpsd").css('display', 'none');
                    $("#forward-rmi").css('display', 'none');
                    $("#forward-file").css('display', 'none');
                    $("#forward-ws").css('display', 'none');
                    $("#forward-console").css('display', 'inline');
                    $("#forward-custom").css('display', 'none');
                    break;
                case 'custom':
                    $("#forward-serial").css('display', 'none');
                    $("#forward-tcp").css('display', 'none');
                    $("#forward-gpsd").css('display', 'none');
                    $("#forward-rmi").css('display', 'none');
                    $("#forward-file").css('display', 'none');
                    $("#forward-ws").css('display', 'none');
                    $("#forward-console").css('display', 'none');
                    $("#forward-custom").css('display', 'inline');
                    break;
                default:
                    break;
            }
        };

        var manageComputerSelection = function(selected) {
            switch (selected) {
                case 'tw-current':
                    $("#computer-twc").css('display', 'inline');
                    $("#computer-custom").css('display', 'none');
                    break;
                case 'custom':
                    $("#computer-twc").css('display', 'none');
                    $("#computer-custom").css('display', 'inline');
                    break;
                default:
                    break;
            }
        };

        var requestChannelCreation = function() {
            var x = document.getElementById("channel-select").value;
            switch (x) {
                case 'serial':
                    var portName = $("#serial-port").val();
                    var br = document.getElementById("baud-rate").value;
                    if (portName.trim().length === 0 || br.trim().length === 0) {
                        alert('Both port name and baud rate are required');
                        return;
                    }
                    var dFilters = $("#serial-dev-filters").val().split(",");
                    var sFilters = $("#serial-sentence-filters").val().split(",");
                    createChannel({
                        type: 'serial',
                        port: portName,
                        br: br,
                        deviceFilters: dFilters,
                        sentenceFilters: sFilters
                    });
                    break;
                case 'tcp':
                    var port = $("#tcp-port").val();
                    var server = $("#tcp-server").val();
                    if (port.trim().length === 0 || server.trim().length === 0) {
                        alert('Both port and server name are required');
                        return;
                    }
                    var dFilters = $("#tcp-dev-filters").val().split(",");
                    var sFilters = $("#tcp-sentence-filters").val().split(",");
                    createChannel({
                        type: 'tcp',
                        port: port,
                        hostname: server,
                        deviceFilters: dFilters,
                        sentenceFilters: sFilters
                    });
                    break;
                case 'file':
                    var logfile = $("#data-file").val();
                    if (logfile.trim().length === 0) {
                        alert('Log file name required');
                        return;
                    }
                    var pause = $("#data-between-reads").val().trim();
                    var betweenReads;
                    try {
                        betweenReads = parseInt(pause);
                    } catch (error) {
                        betweenReads = 500;
                    }
                    var dFilters = $("#data-dev-filters").val().split(",");
                    var sFilters = $("#data-sentence-filters").val().split(",");
                    createChannel({
                        type: 'file',
                        file: logfile,
                        pause: betweenReads,
                        deviceFilters: dFilters,
                        sentenceFilters: sFilters
                    });
                    break;
                case 'ws':
                    var uri = $("#wsuri").val();
                    if (uir.trim().length === 0) {
                        alert('WebSocket URI is required');
                        return;
                    }
                    var dFilters = $("#ws-dev-filters").val().split(",");
                    var sFilters = $("#ws-sentence-filters").val().split(",");
                    createChannel({
                        type: 'ws',
                        wsUri: uri,
                        deviceFilters: dFilters,
                        sentenceFilters: sFilters
                    });
                    break;
                case 'rnd':
                    var dFilters = $("#rnd-dev-filters").val().split(",");
                    var sFilters = $("#rnd-sentence-filters").val().split(",");
                    createChannel({
                        type: 'rnd',
                        deviceFilters: dFilters,
                        sentenceFilters: sFilters
                    });
                    break;
                case 'bmp180':
                    var dFilters = $("#bmp180-dev-filters").val().split(",");
                    var sFilters = $("#bmp180-sentence-filters").val().split(",");
                    var dPrefix = $('#bmp180-dev-prefix').val();
                    createChannel({
                        type: 'bmp180',
                        devicePrefix: dPrefix,
                        deviceFilters: dFilters,
                        sentenceFilters: sFilters
                    });
                    break;
                case 'bme280':
                    var dFilters = $("#bme280-dev-filters").val().split(",");
                    var sFilters = $("#bme280-sentence-filters").val().split(",");
                    var dPrefix = $('#bme280-dev-prefix').val();
                    createChannel({
                        type: 'bme280',
                        devicePrefix: dPrefix,
                        deviceFilters: dFilters,
                        sentenceFilters: sFilters
                    });
                    break;
                case 'lsm303':
                    var dFilters = $("#lsm303-dev-filters").val().split(",");
                    var sFilters = $("#lsm303-sentence-filters").val().split(",");
                    var dPrefix = $('#lsm303-dev-prefix').val();
                    var hOffset = $('#lsm303-heading-offset').val();
	                	var rFreq = $('#lsm303-read-frequency').val();
	                	var dampSize = $('#lsm303-damping-size').val();
                    createChannel({
                        type: 'lsm303',
                        devicePrefix: dPrefix,
                        deviceFilters: dFilters,
                        sentenceFilters: sFilters,
                        headingOffset: hOffset,
												readFrequency: rFreq,
												dampingSize: dampSize
                    });
                    break;
                case 'zda':
                    var dFilters = $("#zda-dev-filters").val().split(",");
                    var sFilters = $("#zda-sentence-filters").val().split(",");
                    var dPrefix = $('#zda-dev-prefix').val();
                    createChannel({
                        type: 'zda',
                        devicePrefix: dPrefix,
                        deviceFilters: dFilters,
                        sentenceFilters: sFilters
                    });
                    break;
                case 'htu21df':
                    var dFilters = $("#htu21df-dev-filters").val().split(",");
                    var sFilters = $("#htu21df-sentence-filters").val().split(",");
                    var dPrefix = $('#htu21df-dev-prefix').val();
                    createChannel({
                        type: 'htu21df',
                        devicePrefix: dPrefix,
                        deviceFilters: dFilters,
                        sentenceFilters: sFilters
                    });
                    break;
                case 'custom':
                    var clientClass = $("#ch-custom-class").val();
                    var readerClass = $("#ch-custom-reader").val();
                    var propfile = $('#ch-custom-prop-file').val();
                    var dFilters = $("#ch-custom-dev-filters").val().split(",");
                    var sFilters = $("#ch-custom-sentence-filters").val().split(",");
                    createChannel({
                        type: 'custom',
                        clientClass: clientClass,
                        readerClass: readerClass,
                        propFile: propfile,
                        deviceFilters: dFilters,
                        sentenceFilters: sFilters
                    });
                    break;
                default:
                    break;
            }
        };

        var requestForwardCreation = function() {
            var x = document.getElementById("forwarder-select").value;
            switch (x) {
                case 'serial':
                    var portName = $("#serial-port-fwd").val();
                    var br = document.getElementById("baud-rate-fwd").value;
                    if (portName.trim().length === 0 || br.trim().length === 0) {
                        alert('Both port name and baud rate are required');
                        return;
                    }
                    createForwarder({
                        type: 'serial',
                        port: portName,
                        br: br
                    });
                    break;
                case 'tcp':
                    var port = $("#fwd-tcp-port").val();
                    if (port.trim().length === 0) {
                        alert('Port is required');
                        return;
                    }
                    createForwarder({
                        type: 'tcp',
                        port: port
                    });
                    break;
                case 'gpsd':
                    var port = $("#fwd-gpsd-port").val();
                    if (port.trim().length === 0) {
                        alert('Port is required');
                        return;
                    }
                    createForwarder({
                        type: 'gpsd',
                        port: port
                    });
                    break;
                case 'rmi':
                    var port = $("#fwd-rmi-port").val();
                    if (port.trim().length === 0) {
                        alert('Port is required');
                        return;
                    }
                    var name = $("#fwd-rmi-binding-name").val();
                    if (name.trim().length === 0) {
                        alert('Name is required');
                        return;
                    }
                    createForwarder({
                        type: 'rmi',
                        port: port,
                        bindingName: name
                    });
                    break;
                case 'file':
                    var logfile = $("#fwd-data-file").val();
                    if (logfile.trim().length === 0) {
                        alert('Log file name is required');
                        return;
                    }
                    var append = $("#fwd-data-file-app").is(':checked');
                    createForwarder({
                        type: 'file',
                        log: logfile,
                        append: append
                    });
                    break;
                case 'ws':
                    var uri = $("#fwd-wsuri").val();
                    if (uri.trim().length === 0) {
                        alert('WebSocket URI is required');
                        return;
                    }
                    createForwarder({
                        type: 'ws',
                        wsUri: uri
                    });
                    break;
                case 'console':
                    createForwarder({
                        type: 'console'
                    });
                    break;
                case 'custom':
                    var forwarderClass = $("#fwd-custom-class").val();
                    var propfile = $('#fwd-custom-prop-file').val();
                    createForwarder({
                        type: 'custom',
                        forwarderClass: forwarderClass,
                        propFile: propfile
                    });
                    break;
                default:
                    break;
            }
        };

        var requestComputerCreation = function() {
            var x = document.getElementById("computer-select").value;
            switch (x) {
                case 'tw-current':
                    var prefix = $("#cptr-twc-prefix").val();
                    var tbl = $("#cptr-twc-tbl").val();
                    if (prefix.trim().length === 0 || tbl.trim().length === 0) {
                        alert('Prefix and TimeBuffer length are required');
                        return;
                    }
                    createComputer({
                        type: 'tw-current',
                        prefix: prefix,
                        timeBufferLength: tbl
                    });
                    break;
                case 'custom':
                    var computerClass = $("#cptr-custom-class").val();
                    var propfile = $('#cptr-custom-prop-file').val();
                    createComputer({
                        type: 'custom',
                        computerClass: computerClass,
                        propFile: propfile
                    });
                    break;
                default:
                    break;
            }
        };

        var manageClick = function(div) {
            document.getElementById('showPorts').className = (div.id === 'showPorts' ? 'selectedButton' : 'unselectedButton');
            document.getElementById('showChannels').className = (div.id === 'showChannels' ? 'selectedButton' : 'unselectedButton');
            document.getElementById('showForwarders').className = (div.id === 'showForwarders' ? 'selectedButton' : 'unselectedButton');
            document.getElementById('showComputers').className = (div.id === 'showComputers' ? 'selectedButton' : 'unselectedButton');
            document.getElementById('showDiagram').className = (div.id === 'showDiagram' ? 'selectedButton' : 'unselectedButton');
            switch (div.id) {
                case 'showPorts':
                    serialPortList();
                    break;
                case 'showChannels':
                    channelList();
                    break;
                case 'showForwarders':
                    forwarderList();
                    break;
                case 'showComputers':
                    computerList();
                    break;
                case 'showDiagram':
                    generateDiagram();
                    break;
                default:
                    break;
            }
        };

        var flowGraph; // The graph itself.
        var flowData = [];
        var GRAPH_MAX_LEN = 300; // 60 = 1 minute

        var idx2plot;

        var graphCallback = function(idx) {
            console.log("Click on pos " + idx + ", flow " + flowData[idx].getY());
            idx2plot = idx;
        };

        window.onload = function() {
          // Available when canvas is visible
//        var canvasWidth = document.getElementById("flowCanvas").getContext('2d').canvas.clientWidth;
//        console.log("Canvas Width:" + canvasWidth);
          flowGraph = new Graph("flowCanvas", flowData, graphCallback, "b/s");

          var interv = setInterval(function() {
              dataVolume();
              forwarderStatus();
              flowGraph.drawGraph("flowCanvas", flowData, idx2plot);
          }, 1000);
        };

        var graphVisible = false;
        var showHideGraph = function() {
            if (flowData.length >= 10) {
                graphVisible = !graphVisible;
             // $("#graphdiv").css('display', graphVisible ? 'block' : 'none');
                if (graphVisible) {
                  $("#graphdiv").show(1000);
                } else {
                  $("#graphdiv").hide(1000);
                }
            } else {
                alert("Not enough data to show on the graph... \n" +
                      "Need at least 10 data points, just got " + flowData.length + "\n" +
                      "Please wait!");
            }
        };
        var toggleForwarders = function() {
          if ("ON" === $("#forwarders-status").text()) {
            enableLogging(false)
          } else {
            enableLogging(true)
          }
        };
        var setSmooth = function(cb) {
            flowGraph.setSmoothing(cb.checked);
        };
        var setTooltip = function(cb) {
            flowGraph.setTooltip(cb.checked);
        };
        var inboudDataInterval;
        var showInboudData = function(cb) {
//          $("#inbound-data-div").css('display', cb.checked ? 'block' : 'none');
            if (cb.checked) {
                $("#inbound-data-div").show(1000);
                pingLastSentence();
            } else {
                $("#inbound-data-div").hide(1000);
                clearInterval(inboudDataInterval);
            }
        };

        var pingLastSentence = function() {
            inboudDataInterval = setInterval(getLastNMEASentence, 1000);
        };

        var shutdownMux = function() {
          if (confirm("You are about to bring the whole Multiplexer down.\nPlease confirm.") === true) {
            terminate();
            document.body.innerHTML = '<h1>Bye-bye...</h1>' +
            '<h2>🏴‍☠️ Server is going down upon your request.</h2>' +
            '<p>Restart the server from a console to continue...</p>';
          } else {
            console.log('Canceled');
          }
        };
    </script>
  </head>
  <body style="background-color: rgba(255, 255, 255, 0.5); background-image: none;">
    <table width="100%">
      <tr>
        <td><h2>NMEA Multiplexer Admin</h2></td>
        <td align="center">Forwarders are <span id="forwarders-status" onclick="toggleForwarders();" title="Click to toggle value" style="cursor: pointer;"></span></td>
        <td align="center">
          Page CSS:
          <select id="css-select" onchange="cssSelectManager();" title="Page StyleSheet">
            <option value="stylesheet.css">Day</option>
            <option value="night.stylesheet.css">Night</option>
            <!-- More here if needed -->
          </select> &nbsp;
          Graph CSS:
          <select id="graph-css-select" onchange="graphCssSelectManager();" title="Graph StyleSheet">
            <option value="graph.ux.01.css">One</option>
            <option value="graph.ux.02.css">Two</option>
            <option value="graph.ux.03.css">Three</option>
            <!-- More here if needed -->
          </select>
        </td>
        <td align="right">Flow <span id="flow" onclick="showHideGraph();" title="Click to show/hide graph" style="cursor: pointer;"></span></td>
      </tr>
      <tr>
        <td colspan="4" align="center">
          <div id="graphdiv" style="display: none;">
            <input type="checkbox" id="smooth-data" onchange="setSmooth(this);">Smoothed <input type="checkbox" id="with-tooltip" onchange="setTooltip(this);">Tooltip
            <br>
            <canvas id="flowCanvas" height="120" title="Flow History"></canvas>
          </div>
        </td>
      </tr>
      <tr>
        <td colspan="1" align="left">Bring the house down: <button title="Really? At your own risk..." onclick="shutdownMux();">Terminate</button></td>
        <td colspan="3" align="right"><input type="checkbox" id="show-inbound-data" onchange="showInboudData(this);">Show Inbound Data</td>
      </tr>
      <tr>
        <td colspan="4" align="left">
          <div id="inbound-data-div" style="display: none; padding: 1px; border-radius: 5px; border: 1px solid #CCC; min-height: 50px; max-height: 100px; overflow-y: scroll;">
          </div>
        </td>
      </tr>
    </table>

    <small>JQuery, Ajax, REST, JSON..., Multiplexer Admin.</small>
    <p>
    <div style="margin-bottom: 0px;">
      <span id="showPorts"  onclick="manageClick(this);"  class="selectedButton" style="margin-left: 5px; cursor: pointer;">Fetch Serial Ports list <img src="refresh_icon.png" width="10" height="12"/></span>
      <span id="showChannels" onclick="manageClick(this);" class="unselectedButton" style="cursor: pointer;">Fetch Channels list <img src="refresh_icon.png" width="10" height="12"/></span>
      <span id="showForwarders" onclick="manageClick(this);" class="unselectedButton" style="cursor: pointer;">Fetch Forwarders list <img src="refresh_icon.png" width="10" height="12"/></span>
      <span id="showComputers" onclick="manageClick(this);" class="unselectedButton" style="cursor: pointer;">Fetch Computers list <img src="refresh_icon.png" width="10" height="12"/></span>
      <span id="showDiagram" onclick="manageClick(this);" class="unselectedButton" style="cursor: pointer;">Full view <img src="refresh_icon.png" width="10" height="12"/></span>
      <button onclick="resetCache();" style="margin-bottom: 3px;">Reset Cache</button>
      <input type='checkbox' onchange='manageMuxVerbose(this);'> Multiplexer verbose
    </div>
    <div id="lists" style="padding: 1px; border-radius: 5px; border: 1px solid #CCC; min-height: 50px; max-height: 200px; overflow-y: scroll;"></div>
    <div id="diagram" style="display: none; padding: 1px; border-radius: 5px; border: 1px solid #CCC; min-height: 50px;"></div>
    <div id="show-hide-raw-data" onclick="showHideRESTData();" style="cursor: pointer; margin-top: 5px;"><small>&nbsp;<img src='panright.gif'> Show REST Traffic</small></div>
    <div id="raw-data-div" style="display: none;">
      <table width="100%" border="0">
        <tr>
          <td style="width: 50%;" valign="top" title="In&#013;(From the server)">
            <div id="raw-data" style="padding: 1px; border-radius: 5px; border: 1px solid #CCC; min-height: 50px; max-height: 200px; overflow-y: scroll;"></div>
          </td>
          <td style="width: 40%;" valign="top" title="Out&#013;(From client to Server)">
            <div id="raw-data-out" style="padding: 1px; border-radius: 5px; border: 1px solid #CCC; min-height: 50px; max-height: 200px; overflow-y: scroll;"></div>
          </td>
          <td style="width: 10%;" valign="top" title="Elapsed">
            <div id="rest-elapsed" style="padding: 1px; border-radius: 5px; border: 1px solid #CCC; min-height: 50px; max-height: 200px; overflow-y: scroll;"></div>
          </td>
        </tr>
        <tr>
          <td colspan="1">
            <button onclick="clearRESTData();">Clear</button>
          </td>
          <td colspan="2">
            <button onclick="clearRESTOutData();">Clear</button>
          </td>
        </tr>
      </table>
    </div>
    </p>
    <p>
      <button onclick="showAddChannel();">Add a Channel</button>&nbsp;
      <button onclick="showAddForwarder();">Add a Forwarder</button>&nbsp;
      <button onclick="showAddComputer();">Add a Computer</button>
      <div id="add-channel" style="display: none;">
        <hr/>
        <h4>Add an input Channel</h4>
        <table style="padding: 5px; border-radius: 5px; border: 1px solid #CCC; margin-bottom: 5px;">
          <tr>
            <td valign="top">
              <select id="channel-select" onchange="channelSelectManager();">
                <option value="serial">Serial</option>
                <option value="tcp">TCP</option>
                <option value="file">Data File</option>
                <option value="ws">Web Socket</option>
                <option value="rnd">Random</option>
                <option value="bmp180">BMP180</option>
                <option value="bme280">BME280</option>
                <option value="lsm303">LSM303</option>
                <option value="htu21df">HTU21DF</option>
                <option value="zda">ZDA</option>
                <option value="custom">Custom</option>
              </select>
            </td>
            <td valign="top">
              <div id="channel-serial" style="display: inline;">
                <table>
                  <tr>
                    <td>Port</td>
                    <td><input id="serial-port" type="text" placeholder="Serial Port Name" size="30"></td>
                  </tr>
                  <tr>
                    <td>Baud Rate</td>
                    <td>
                      <select id="baud-rate">
                        <option value="1200">1200</option>
                        <option value="2400">2400</option>
                        <option value="4800">4800</option>
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                      </select>
                    </td>
                  </tr>
                  <tr>
                    <td>Device filter(s)</td>
                    <td><input id="serial-dev-filters" type="text" placeholder="Device filters, II, ~GP" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Sentence filter(s)</td>
                    <td><input id="serial-sentence-filters" type="text" placeholder="Sentence filters, GLL, ~RMC" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                </table>
              </div>
              <div id="channel-tcp" style="display: none;">
                <table>
                  <tr>
                    <td>Server</td>
                    <td><input id="tcp-server" type="text" placeholder="Server Name" size="20"></td>
                  </tr>
                  <tr>
                    <td>Port</td>
                    <td><input id="tcp-port" type="text" placeholder="Port" size="10"></td>
                  </tr>
                  <tr>
                    <td>Device filter(s)</td>
                    <td><input id="tcp-dev-filters" type="text" placeholder="Device filters, II, ~GP" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Sentence filter(s)</td>
                    <td><input id="tcp-sentence-filters" type="text" placeholder="Sentence filters, GLL, ~RMC" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                </table>
              </div>
              <div id="channel-file" style="display: none;">
                <table>
                  <tr>
                    <td>Data File</td>
                    <td><input id="data-file" type="text" placeholder="Log File" size="30"></td>
                  </tr>
                  <tr>
                    <td>Between reads</td>
                    <td><input id="data-between-reads" type="text" placeholder="500 ms" size="30"></td>
                  </tr>
                  <tr>
                    <td>Device filter(s)</td>
                    <td><input id="data-dev-filters" type="text" placeholder="Device filters, II, ~GP" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Sentence filter(s)</td>
                    <td><input id="data-sentence-filters" type="text" placeholder="Sentence filters, GLL, ~RMC" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                </table>
              </div>
              <div id="channel-ws" style="display: none;">
                <table>
                  <tr>
                    <td>WebSocket URI</td>
                    <td><input id="wsuri" type="text" placeholder="ws://machine-name:9876/" size="30"></td>
                  </tr>
                  <tr>
                    <td>Device filter(s)</td>
                    <td><input id="ws-dev-filters" type="text" placeholder="Device filters, II, ~GP" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Sentence filter(s)</td>
                    <td><input id="ws-sentence-filters" type="text" placeholder="Sentence filters, GLL, ~RMC" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                </table>
              </div>
              <div id="channel-rnd" style="display: none;">
                <table>
                  <tr>
                    <td>Device filter(s)</td>
                    <td><input id="rnd-dev-filters" type="text" placeholder="Device filters, II, ~GP" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Sentence filter(s)</td>
                    <td><input id="rnd-sentence-filters" type="text" placeholder="Sentence filters, GLL, ~RMC" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                </table>
              </div>
              <div id="channel-bmp180" style="display: none;">
                <table>
                  <tr>
                    <td>Device Prefix</td>
                    <td><input id="bmp180-dev-prefix" type="text" placeholder="Device Prefix" size="10" value="RP"></td>
                  </tr>
                  <tr>
                    <td>Device filter(s)</td>
                    <td><input id="bmp180-dev-filters" type="text" placeholder="Device filters, II, ~GP" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Sentence filter(s)</td>
                    <td><input id="bmp180-sentence-filters" type="text" placeholder="Sentence filters, GLL, ~RMC" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                </table>
              </div>
              <div id="channel-bme280" style="display: none;">
                <table>
                  <tr>
                    <td>Device Prefix</td>
                    <td><input id="bme280-dev-prefix" type="text" placeholder="Device Prefix" size="10" value="RP"></td>
                  </tr>
                  <tr>
                    <td>Device filter(s)</td>
                    <td><input id="bme280-dev-filters" type="text" placeholder="Device filters, II, ~GP" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Sentence filter(s)</td>
                    <td><input id="bme280-sentence-filters" type="text" placeholder="Sentence filters, GLL, ~RMC" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                </table>
              </div>
              <div id="channel-lsm303" style="display: none;">
                <table>
                  <tr>
                    <td>Device Prefix</td>
                    <td><input id="lsm303-dev-prefix" type="text" placeholder="Device Prefix" size="10" value="II"></td>
                  </tr>
                  <tr>
                    <td>Device filter(s)</td>
                    <td><input id="lsm303-dev-filters" type="text" placeholder="Device filters, II, ~GP" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Sentence filter(s)</td>
                    <td><input id="lsm303-sentence-filters" type="text" placeholder="Sentence filters, GLL, ~RMC" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Heading Offset</td>
                    <td><input id="lsm303-heading-offset" type="text" placeholder="0" size="4" style="text-align: right;"></td>
                    <td><small>Integer<b>[-180..180]</b></small></td>
                  </tr>
									<tr>
										<td>Read Frequency</td>
										<td><input id="lsm303-read-frequency" type="text" placeholder="1000" size="4" style="text-align: right;"></td>
										<td><small>in ms</small></td>
									</tr>
									<tr>
										<td>Damping Size</td>
										<td><input id="lsm303-damping-size" type="text" placeholder="200" size="4" style="text-align: right;"></td>
										<td><small>in elements</small></td>
									</tr>
                </table>
              </div>
              <div id="channel-zda" style="display: none;">
                <table>
                  <tr>
                    <td>Device Prefix</td>
                    <td><input id="zda-dev-prefix" type="text" placeholder="Device Prefix" size="10" value="GP"></td>
                  </tr>
                  <tr>
                    <td>Device filter(s)</td>
                    <td><input id="zda-dev-filters" type="text" placeholder="Device filters, II, ~GP" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Sentence filter(s)</td>
                    <td><input id="zda-sentence-filters" type="text" placeholder="Sentence filters, GLL, ~RMC" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                </table>
              </div>
              <div id="channel-htu21df" style="display: none;">
                <table>
                  <tr>
                    <td>Device Prefix</td>
                    <td><input id="htu21df-dev-prefix" type="text" placeholder="Device Prefix" size="10" value="RP"></td>
                  </tr>
                  <tr>
                    <td>Device filter(s)</td>
                    <td><input id="htu21df-dev-filters" type="text" placeholder="Device filters, II, ~GP" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Sentence filter(s)</td>
                    <td><input id="htu21df-sentence-filters" type="text" placeholder="Sentence filters, GLL, ~RMC" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                </table>
              </div>
              <div id="channel-custom" style="display: none;">
                <table>
                  <tr>
                    <td>Client Class</td>
                    <td><input id="ch-custom-class" type="text" placeholder="Client Class" size="30"></td>
                  </tr>
                  <tr>
                    <td>Reader Class</td>
                    <td><input id="ch-custom-reader" type="text" placeholder="Reader Class" size="30"></td>
                  </tr>
                  <tr>
                    <td>Properties file</td>
                    <td><input id="ch-custom-prop-file" type="text" placeholder="Properties file name" size="30"></td>
                  </tr>
                  <tr>
                    <td>Device filter(s)</td>
                    <td><input id="ch-custom-dev-filters" type="text" placeholder="Device filters, II, ~GP" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                  <tr>
                    <td>Sentence filter(s)</td>
                    <td><input id="ch-custom-sentence-filters" type="text" placeholder="Sentence filters, GLL, ~RMC" size="30"></td>
                    <td><small>Negate with <b>~</b></small></td>
                  </tr>
                </table>
              </div>
            </td>
          </tr>
        </table>
        <button onclick="requestChannelCreation();">Add</button>
      </div>
      <div id="add-forwarder" style="display: none;">
        <hr/>
        <h4>Add a forwarder</h4>
        <table style="padding: 5px; border-radius: 5px; border: 1px solid #CCC; margin-bottom: 5px;">
          <tr>
            <td valign="top">
              <select id="forwarder-select" onchange="forwardSelectManager();">
                <option value="serial">Serial</option>
                <option value="tcp">TCP</option>
                <option value="gpsd">GPSd</option>
                <option value="rmi">RMI</option>
                <option value="file">Data File</option>
                <option value="ws">Web Socket</option>
                <option value="console">Console</option>
                <option value="custom">Custom</option>
              </select>
            </td>
            <td valign="top">
              <div id="forward-serial" style="display: inline;">
                <table>
                  <tr>
                    <td>Port</td>
                    <td><input id="serial-port-fwd" type="text" placeholder="Serial Port Name" size="30"></td>
                  </tr>
                  <tr>
                    <td>Baud Rate</td>
                    <td>
                      <select id="baud-rate-fwd">
                        <option value="1200">1200</option>
                        <option value="2400">2400</option>
                        <option value="4800">4800</option>
                        <option value="9600">9600</option>
                        <option value="19200">19200</option>
                      </select>
                    </td>
                  </tr>
                </table>
              </div>
              <div id="forward-tcp" style="display: none;">
                <table>
                  <tr>
                    <td>Port</td>
                    <td><input id="fwd-tcp-port" type="text" placeholder="Port" size="10"></td>
                  </tr>
                </table>
              </div>
              <div id="forward-gpsd" style="display: none;">
                <table>
                  <tr>
                    <td>Port</td>
                    <td><input id="fwd-gpsd-port" type="text" placeholder="Port, like 2947" size="10"></td>
                  </tr>
                </table>
              </div>
              <div id="forward-rmi" style="display: none;">
                <table>
                  <tr>
                    <td>Port</td>
                    <td><input id="fwd-rmi-port" type="text" placeholder="Port" size="10"></td>
                  </tr>
                  <tr>
                    <td>Binding Name</td>
                    <td><input id="fwd-rmi-binding-name" type="text" placeholder="Binding Name" size="20"></td>
                  </tr>
                </table>
              </div>
              <div id="forward-file" style="display: none;">
                <table>
                  <tr>
                    <td>Data File</td>
                    <td><input id="fwd-data-file" type="text" placeholder="Log File" size="30"></td>
                    <td><input type='checkbox' id="fwd-data-file-app" title="Reset, or append."> Append</td>
                  </tr>
                </table>
              </div>
              <div id="forward-ws" style="display: none;">
                <table>
                  <tr>
                    <td>WebSocket URI</td>
                    <td><input id="fwd-wsuri" type="text" placeholder="ws://machine-name:9876/" size="30"></td>
                  </tr>
                </table>
              </div>
              <div id="forward-console" style="display: none;">
                <i>No Parameters</i>
              </div>
              <div id="forward-custom" style="display: none;">
                <table>
                  <tr>
                    <td>Forwarder Class</td>
                    <td><input id="fwd-custom-class" type="text" placeholder="Forwarder Class" size="30"></td>
                  </tr>
                  <tr>
                    <td>Properties file</td>
                    <td><input id="fwd-custom-prop-file" type="text" placeholder="Properties file name" size="30"></td>
                  </tr>
                </table>
              </div>
            </td>
          </tr>
        </table>
        <button onclick="requestForwardCreation();">Add</button>
      </div>
      <div id="add-computer" style="display: none;">
        <hr/>
        <h4>Add a computer</h4>
        <table style="padding: 5px; border-radius: 5px; border: 1px solid #CCC; margin-bottom: 5px;">
          <tr>
            <td valign="top">
              <select id="computer-select" onchange="computerSelectManager();">
                <option value="tw-current">True Wind and Current</option>
                <option value="custom">Custom</option>
              </select>
            </td>
            <td valign="top">
              <div id="computer-twc" style="display: inline;">
                <table>
                  <tr>
                    <td>Prefix</td>
                    <td><input id="cptr-twc-prefix" type="text" placeholder="OS" size="5"></td>
                  </tr>
                  <tr>
                    <td>Time Buffer Length</td>
                    <td><input id="cptr-twc-tbl" type="text" placeholder="60, 120, 300" size="30"> in <i>seconds</i>.</td>
                  </tr>
                </table>
              </div>
              <div id="computer-custom" style="display: none;">
                <table>
                  <tr>
                    <td>Computer Class</td>
                    <td><input id="cptr-custom-class" type="text" placeholder="Computer Class" size="30"></td>
                  </tr>
                  <tr>
                    <td>Properties file</td>
                    <td><input id="cptr-custom-prop-file" type="text" placeholder="Properties file name" size="30"></td>
                  </tr>
                </table>
              </div>
            </td>
          </tr>
        </table>
        <button onclick="requestComputerCreation();">Add</button>
    </div>
    <div id="err-mess" style="color: red;"></div>
    <hr/>
    <!--button onclick="protocolTest();">Protocol test</button>
    <hr/-->
    <address>Oliv fecit, AD 2016.</address>
  </body>
</html>
