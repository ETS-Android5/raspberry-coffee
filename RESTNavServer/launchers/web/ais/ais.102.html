<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AIS with Leaflet</title>
    <link rel="icon" type="image/jpg" href="../icons/jellyfish.ico">
    <style type="text/css">
        * {
            font-family: "Source Code Pro", "Courier New", "Helvetica Neue", "Lato", Verdana, Helvetica, Geneva, sans-serif;
            color: navy;
        }
        h1 {
            font-size: x-large;
            font-weight: bold;
        }
        td, th {
            border: 1px solid silver;
            border-radius: 5px;
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

</head>
<body>
<h1>AIS plotter</h1>
<hr/>
<table>
    <tr>
        <td valign="top">
            <!--div id="mapid" style="width: 1200px; height: 800px;"></div-->
            <div id="mapid" style="width: 1200px; height: 600px;"></div>
        </td>
        <td valign="top" align="left" style="padding: 5px;">
            <i><b>Mouse position:</b></i>
            <hr/>
            <small><i>Degrees, Decimal minutes:</i></small>
            <div id="curr-pos"></div>
            <hr/>
            <small><i>Decimal:</i></small>
            <div id="curr-pos-dec"></div>
            <hr/>
            <i><b>Last click position:</b></i>
            <hr/>
            <small><i>Degrees, Decimal minutes:</i></small>
            <div id="curr-pos-click"></div>
            <hr/>
            <small><i>Decimal:</i></small>
            <div id="curr-pos-click-dec"></div>
            <hr/>
            <span id="ais-status"></span>
        </td>
    </tr>
</table>
<hr/>
<span style="font-style: italic;">&copy 2020, Oliv did it.</span>

</body>

<script type="text/javascript">

    if (Math.toRadians == undefined) {
        Math.toRadians = deg => {
            return (deg / 180) * Math.PI;
        };
    }

    function getQSPrm(prm) {
        let loc = document.location.toString();
        if (loc.indexOf("?") > -1) {
            let qs = loc.substring(loc.indexOf("?") + 1);
            let prms = qs.split('&');
            for (let i=0; i<prms.length; i++) {
                let nv = prms[i].split('=');
                if (nv.length === 2) {
                    if (nv[0] === prm) {
                        return nv[1];
                    }
                }
            }
        }
        return null;
    }

    let options = {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
    };

    let userPos = {
        lat: 37.75,
        lng: -122.5
    }; // Default. Will get this from NMEA Pos

    function decToSex(val, ns_ew) {
        let absVal = Math.abs(val);
        let intValue = Math.floor(absVal);
        let dec = absVal - intValue;
        let i = intValue;
        dec *= 60;
        let s = i + "°" + dec.toFixed(2) + "'";

        if (val < 0) {
            s += (ns_ew === 'NS' ? 'S' : 'W');
        } else {
            s += (ns_ew === 'NS' ? 'N' : 'E');
        }
        return s;
    }

    let map = L.map('mapid'); // .setView([currentLatitude, currentLongitude], 13);

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 28,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(map);

    map.fitBounds([
        [40.712, -74.227],
        [40.774, -74.125]
    ]);

    let currentBound = [];
    let mapMarkers = [];

    map.addEventListener('mousemove', (event) => {
        // let lat = Math.round(event.latlng.lat * 100000) / 100000;
        // let lng = Math.round(event.latlng.lng * 100000) / 100000;
        document.getElementById('curr-pos').innerHTML = `${decToSex(event.latlng.lat, "NS")}<br/>${decToSex(event.latlng.lng, "EW")}`;
        document.getElementById('curr-pos-dec').innerHTML = `${event.latlng.lat}<br/>${event.latlng.lng}`;
    });
    map.addEventListener('click', (event) => {
        // let lat = Math.round(event.latlng.lat * 100000) / 100000;
        // let lng = Math.round(event.latlng.lng * 100000) / 100000;
        document.getElementById('curr-pos-click').innerHTML = `${decToSex(event.latlng.lat, "NS")}<br/>${decToSex(event.latlng.lng, "EW")}`;
        document.getElementById('curr-pos-click-dec').innerHTML = `${event.latlng.lat}<br/>${event.latlng.lng}`;
    });

    let onMessage = json => {
        currentBound = []; // Reset
        if (userPos !== null) {
            currentBound.push([userPos.lat, userPos.lng]);
            // Remove all markers from the map
            mapMarkers.forEach(mark => {
               map.removeLayer(mark);
            });

            if (json["Position"] !== undefined) {
                userPos.lat = json["Position"].lat;
                userPos.lng = json["Position"].lng;
            }
            let marker =  L.marker([userPos.lat, userPos.lng]);
            mapMarkers.push(marker);
            marker.addTo(map)
                .bindPopup(`<b>You are here<br/><span style="color: red;">${decToSex(userPos.lat, "NS")}<br/>${decToSex(userPos.lng, "EW")}</span></b>`);
        }
        if (json.ais !== null && json.ais !== undefined) {
            let ais = json.ais;
            let keys = Object.keys(ais);
            document.getElementById("ais-status").innerHTML = `${keys.length} AIS record(s)`;
            for (let i=0; i<keys.length; i++) { // MMSI
                let k = keys[i];
                let aisRecord = ais[k];
                let MMSI = k;
                let aisKeys = Object.keys(aisRecord);
                for (let j=0; j<aisKeys.length; j++) { // Record types
                    let aisKey = aisKeys[j];
                    // console.log("Key:" + aisKey);
                    let recordType = aisRecord[aisKey].messageType; // Same as str(aisKey)
                    let recordDescription = aisRecord[aisKey].messageDescription;
                    let oneRecord = aisRecord[aisKey].recordContent;
                    let isBoat = false;
                    if (oneRecord !== undefined) {
                        console.log(`AIS for MMSI ${MMSI}, type ${recordType}`);
                        if (oneRecord.latitude !== null && oneRecord.latitude !== undefined &&
                            oneRecord.longitude !== null && oneRecord.longitude !== undefined) {
                            console.log(`MMSI: ${MMSI}\nRecord Type ${recordType}\nAt ${oneRecord.latitude} / ${oneRecord.longitude}`);
                            if (oneRecord.longitude < 180 && oneRecord.longitude > -180) {
                                // Put in array for Leaflet
                                currentBound.push([oneRecord.latitude, oneRecord.longitude]);
                                if (oneRecord.hdg !== undefined && oneRecord.cog !== undefined && oneRecord.sog !== undefined) {
                                    isBoat = true;
                                }
                                // console.log(`MMSI: ${MMSI}\nRecord Type ${recordType}\nAt ${oneRecord.latitude} / ${oneRecord.longitude}, boat:${isBoat}`);
                                if (isBoat) { // It's a boat
                                    // HDG=511 => n/a
                                    // Draw a boat, use oneRecord.hdg, oneRecord.cog
                                    let boatLen = 0.02;
                                    let hdg = oneRecord.hdg;
                                    let cog = oneRecord.cog;
                                    if (hdg === 511) {
                                        hdg = cog;
                                        cog = null;
                                    }
                                    let boatTriangle = L.polygon([ // HDG
                                        [oneRecord.latitude + ((boatLen / 2) * Math.cos(Math.toRadians(hdg))),
                                            oneRecord.longitude + ((boatLen / 2) * Math.sin(Math.toRadians(hdg)))], // Bow
                                        [oneRecord.latitude - ((boatLen / 2) * Math.cos(Math.toRadians(hdg - 10))),
                                            oneRecord.longitude - ((boatLen / 2) * Math.sin(Math.toRadians(hdg - 10)))],
                                        [oneRecord.latitude - ((boatLen / 2) * Math.cos(Math.toRadians(hdg - 0))),
                                            oneRecord.longitude - ((boatLen / 2) * Math.sin(Math.toRadians(hdg - 0)))],
                                        [oneRecord.latitude - ((boatLen / 2) * Math.cos(Math.toRadians(hdg + 10))),
                                            oneRecord.longitude - ((boatLen / 2) * Math.sin(Math.toRadians(hdg + 10)))]
                                    ], {
                                        color: 'yellow',
                                        fillColor: '#ff3',
                                        fillOpacity: 0.5
                                    });
                                    mapMarkers.push(boatTriangle);
                                    boatTriangle.addTo(map);

                                    if (cog !== null) {
                                        let boatCog = L.polyline([ // COG
                                            [oneRecord.latitude + ((boatLen * 1.1 / 2) * Math.cos(Math.toRadians(cog))),
                                                oneRecord.longitude + ((boatLen * 1.1 / 2) * Math.sin(Math.toRadians(cog)))], // Bow
                                            [oneRecord.latitude - ((boatLen * 1.1 / 2) * Math.cos(Math.toRadians(cog))),
                                                oneRecord.longitude - ((boatLen * 1.1 / 2) * Math.sin(Math.toRadians(cog)))]
                                        ], {
                                            color: 'blue'
                                        });
                                        mapMarkers.push(boatCog);
                                        boatCog.addTo(map);
                                    }

                                    let boatSpot = L.circle([oneRecord.latitude, oneRecord.longitude], {
                                        color: 'red',
                                        fillColor: '#f03',
                                        fillOpacity: 0.5,
                                        radius: 500
                                    });
                                    mapMarkers.push(boatSpot);
                                    boatSpot.addTo(map);
                                }
                                // Popup
                                let marker = L.marker([oneRecord.latitude, oneRecord.longitude]);
                                mapMarkers.push(marker);
                                let popupText = `Record #${i}/${j}, type ${recordType}<br/>${recordDescription !== null ? recordDescription + "<br/>" : ""}<b>MMSI ${MMSI}<br/><span style="color: red;">${decToSex(oneRecord.latitude, "NS")}<br/>${decToSex(oneRecord.longitude, "EW")}</span></b>`;
                                if (isBoat) {
                                    popupText += `<br/>SOG: ${oneRecord.sog}<br/>COG: ${oneRecord.cog}<br/>HDG: ${oneRecord.hdg}`;
                                }
                                marker.addTo(map)
                                    .bindPopup(popupText);
                            } else {
                                console.log(`Longitude Problem: MMSI: ${MMSI}\nRecord Type ${recordType}\nAt ${oneRecord.latitude} / ${oneRecord.longitude}`);
                            }
                        }
                    }
                }
            }
            if (currentBound.length > 0) {
                map.fitBounds(currentBound);
            }
        } else {
            // console.info("No AIS");
            document.getElementById("ais-status").innerHTML = "No AIS";
            map.panTo(new L.LatLng(userPos.lat, userPos.lng));
        }
    };

    function getNMEAData() {

        let url = /*'http://192.168.42.6:9999' + */ '/mux/cache',
            // xhr = new XMLHttpRequest(),
            verb = 'GET',
            TIMEOUT = 10000,
            happyCode = 200,
            data = null;

        let promise = new Promise(function (resolve, reject) {
            let xhr = new XMLHttpRequest();

            // let req = verb + " " + url;
            // if (data !== undefined && data !== null) {
            //     req += ("\n" + JSON.stringify(data, null, 2));
            // }
            xhr.open(verb, url, true);
            xhr.setRequestHeader("Content-type", "application/json");
            try {
                if (data === undefined || data === null) {
                    xhr.send();
                } else {
                    xhr.send(JSON.stringify(data));
                }
            } catch (err) {
                console.log("Send Error ", err);
            }

            let requestTimer = setTimeout(() => {
                xhr.abort();
                let mess = {code: 408, message: 'Timeout'};
                reject(mess);
            }, TIMEOUT);

            xhr.onload = () => {
                clearTimeout(requestTimer);
                if (xhr.status === happyCode) {
                    resolve(xhr.response);
                } else {
                    reject({code: xhr.status, message: xhr.response});
                }
            };
        });
        return promise;
    }

    function fetch() {
        let getData = getNMEAData();
        getData.then((value) => {
            //  console.log("Done:", value);
            let json = JSON.parse(value);
            onMessage(json);
        }, (error, errmess) => {
            let message;
            if (errmess !== undefined) {
                try {
                    let mess = JSON.parse(errmess);
                    if (mess.message !== undefined) {
                        message = mess.message;
                    }
                } catch (err) {
                    //  console.log(errmess);
                }
            }
            console.log("Failed to get nmea data..." + (error !== undefined ? JSON.stringify(error) : ' - ') + ', ' + (message !== undefined ? message : ' - '));
        });

    }

    let betweenPing = 5000;
    let FOR_TEST = (getQSPrm("test") === 'true');

    if (!FOR_TEST) {
        (() => {
            // Long poll for NMEA/AIS
            setInterval(() => {
                fetch();
            }, betweenPing);
        })();
    } else {
        // For tests
        let json = {
            "NMEA_AS_IS": {
                "AIS": "!AIVDM,1,1,,B,36=;8>01i4o>MdPEVFhj2AlP20qQ,0*6E"
            },
            "Damping": 1,
            "Current calculated with damping": {},
            "HDG Offset": 0.0,
            "Position": {
                "lat": 37.7489,
                "lng": -122.507,
                "gridSquare": "CM87rr"
            },
            "Default Declination": {
                "angle": 0.0
            },
            "Deviation file name": "zero-deviation.csv",
            "ais": {
                "416467000": {
                    "3": {
                        "messageType": 3,
                        "repeatIndicator": 0,
                        "MMSI": 416467000,
                        "recordTimeStamp": 1601232797854,
                        "recordContent": {
                            "utc": 16,
                            "rot": 7,
                            "latitude": 37.747528,
                            "NavStatus": 0,
                            "PosAcc": 1,
                            "sog": 6.8,
                            "cog": 52.1,
                            "hdg": 58,
                            "longitude": -122.66941
                        }
                    }
                },
                "3669708": {
                    "4": {
                        "messageType": 4,
                        "repeatIndicator": 0,
                        "MMSI": 3669708,
                        "recordTimeStamp": 1601232528494,
                        "recordContent": {
                            "UtcYear": 2020,
                            "UtcHour": 15,
                            "UtcMinute": 22,
                            "UtcSecond": 40,
                            "latitude": 37.923153,
                            "PosAcc": 1,
                            "UtcMonth": 9,
                            "UtDay": 25,
                            "longitude": -122.59845
                        }
                    }
                }
            },
            "BSP Factor": 1.0,
            "Max Leeway": 0.0,
            "AWS Factor": 1.0,
            "AWA Offset": 0.0,
            "NMEA": "!AIVDM,1,1,,B,36=;8>01i4o>MdPEVFhj2AlP20qQ,0*6E"
        };
        onMessage(json);
    }
</script>
</html>
