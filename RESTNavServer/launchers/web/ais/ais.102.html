<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AIS with Leaflet</title>
    <link rel="icon" type="image/jpg" href="../icons/jellyfish.ico">
    <style type="text/css">
        * {
            font-family: "Source Code Pro", "Courier New", "Helvetica Neue", "Lato", Verdana, Helvetica, Geneva, sans-serif;
            color: navy;
        }
        h1 {
            font-size: x-large;
            font-weight: bold;
        }
        td, th {
            border: 1px solid silver;
            border-radius: 5px;
        }
    </style>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

</head>
<body>
<h1>AIS plotter</h1>
<hr/>
<table>
    <tr>
        <td valign="top">
            <!--div id="mapid" style="width: 1200px; height: 800px;"></div-->
            <div id="mapid" style="width: 1200px; height: 600px;"></div>
        </td>
        <td valign="top" align="left">
            <input type="checkbox" id="keep-centered"/> Keep map centered on current GPS position
            <hr/>
            <i><b>Mouse position:</b></i>
            <hr/>
            <div id="curr-pos"></div>
            <hr/>
            <small><i>Decimal:</i></small>
            <div id="curr-pos-dec"></div>
            <hr/>
            <i><b>Last click position:</b></i>
            <hr/>
            <div id="curr-pos-click"></div>
            <hr/>
            <small><i>Decimal:</i></small>
            <div id="curr-pos-click-dec"></div>
            <hr/>
        </td>
    </tr>
</table>
<hr/>
<span style="font-style: italic;">&copy 2020, Oliv did it.</span>

</body>

<script type="text/javascript">

    if (Math.toRadians == undefined) {
        Math.toRadians = deg => {
            return (deg / 180) * Math.PI;
        };
    }

    let options = {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
    };

    let userPos = {
        lat: 37.75,
        lng: -122.5
    }; // TODO Get this from NMEA Pos

    function decToSex(val, ns_ew) {
        let absVal = Math.abs(val);
        let intValue = Math.floor(absVal);
        let dec = absVal - intValue;
        let i = intValue;
        dec *= 60;
        let s = i + "°" + dec.toFixed(2) + "'";

        if (val < 0) {
            s += (ns_ew === 'NS' ? 'S' : 'W');
        } else {
            s += (ns_ew === 'NS' ? 'N' : 'E');
        }
        return s;
    }

    let map = L.map('mapid'); // .setView([currentLatitude, currentLongitude], 13);

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
        maxZoom: 28,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
            '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
            'Imagery © <a href="http://mapbox.com">Mapbox</a>',
        id: 'mapbox.streets'
    }).addTo(map);

    map.fitBounds([
        [40.712, -74.227],
        [40.774, -74.125]
    ]);

    let currentBound = [];
    let mapMarkers = [];

    map.addEventListener('mousemove', (event) => {
        // let lat = Math.round(event.latlng.lat * 100000) / 100000;
        // let lng = Math.round(event.latlng.lng * 100000) / 100000;
        document.getElementById('curr-pos').innerHTML = `${decToSex(event.latlng.lat, "NS")}<br/>${decToSex(event.latlng.lng, "EW")}`;
        document.getElementById('curr-pos-dec').innerHTML = `${event.latlng.lat}<br/>${event.latlng.lng}`;
    });
    map.addEventListener('click', (event) => {
        // let lat = Math.round(event.latlng.lat * 100000) / 100000;
        // let lng = Math.round(event.latlng.lng * 100000) / 100000;
        document.getElementById('curr-pos-click').innerHTML = `${decToSex(event.latlng.lat, "NS")}<br/>${decToSex(event.latlng.lng, "EW")}`;
        document.getElementById('curr-pos-click-dec').innerHTML = `${event.latlng.lat}<br/>${event.latlng.lng}`;
    });

    let onMessage = json => {
        currentBound = []; // Reset
        if (userPos !== null) {
            currentBound.push([userPos.lat, userPos.lng]);
            // Remove all markers from the map
            mapMarkers.forEach(mark => {
               map.removeLayer(mark);
            });

            let marker =  L.marker([userPos.lat, userPos.lng]);
            mapMarkers.push(marker);
            marker.addTo(map)
                .bindPopup(`<b>You are here<br/><span style="color: red;">${decToSex(userPos.lat, "NS")}<br/>${decToSex(userPos.lng, "EW")}</span></b>`);
        }
        if (json.ais !== null && json.ais !== undefined) {
            let ais = json.ais;
            let keys = Object.keys(ais);
            for (let i=0; i<keys.length; i++) {
                let k = keys[i];
                let aisRecord = ais[k];
                let MMSI = k;
                let aisKeys = Object.keys(aisRecord);
                for (let j=0; j<aisKeys.length; j++) {
                    let aisKey = aisKeys[j];
                    // console.log("Key:" + aisKey);
                    let recordType = aisRecord[aisKey].messageType; // Same as str(aisKey)
                    let oneRecord = aisRecord[aisKey].recordContent;
                    let isBoat = false;
                    if (oneRecord !== undefined) {
                        if (oneRecord.latitude !== null && oneRecord.latitude !== undefined &&
                            oneRecord.longitude !== null && oneRecord.longitude !== undefined) {
                            console.log(`MMSI: ${MMSI}\nRecord Type ${recordType}\nAt ${oneRecord.latitude} / ${oneRecord.longitude}`);
                            // Put in array for Leaflet
                            currentBound.push([oneRecord.latitude, oneRecord.longitude]);
                            if (oneRecord.hdg !== undefined && oneRecord.cog !== undefined && oneRecord.sog !== undefined) {
                                isBoat = true;
                            }

                            if (isBoat) { // It's a boat
                                // Draw a boat, use oneRecord.hdg, oneRecord.cog
                                let boatLen = 1;
                                let boatAxis = L.polyline([
                                    [oneRecord.latitude + ((boatLen / 2) * Math.sin(Math.toRadians(oneRecord.cog))),
                                     oneRecord.longitude - ((boatLen / 2) * Math.cos(Math.toRadians(oneRecord.cog)))], // Bow
                                    [oneRecord.latitude - ((boatLen / 2) * Math.sin(Math.toRadians(oneRecord.cog))),
                                        oneRecord.longitude + ((boatLen / 2) * Math.cos(Math.toRadians(oneRecord.cog)))]                                ]);
                                let boatDrawing = L.circle([oneRecord.latitude, oneRecord.longitude], {
                                    color: 'red',
                                    fillColor: '#f03',
                                    fillOpacity: 0.5,
                                    radius: 500
                                });
                                mapMarkers.push(boatDrawing);
                                boatDrawing.addTo(map);
                                mapMarkers.push(boatAxis);
                                boatAxis.addTo(map);
                            }

                            let marker = L.marker([oneRecord.latitude, oneRecord.longitude])
                            mapMarkers.push(marker);
                            let popupText = `<b>MMSI ${MMSI}<br/><span style="color: red;">${decToSex(oneRecord.latitude, "NS")}<br/>${decToSex(oneRecord.longitude, "EW")}</span></b>`;
                            if (isBoat) {
                                popupText += `<br/>SOG: ${oneRecord.sog}<br/>COG: ${oneRecord.cog}<br/>HDG: ${oneRecord.hdg}`;
                            }
                            marker.addTo(map)
                                .bindPopup(popupText);
                        }
                    }
                }
            }
            if (currentBound.length > 0) {
                map.fitBounds(currentBound);
            }
        } else {
            console.info("No AIS");
        }
    };

    function getNMEAData() {

        let url = /*'http://192.168.42.6:9999' + */ '/mux/cache',
            // xhr = new XMLHttpRequest(),
            verb = 'GET',
            TIMEOUT = 10000,
            happyCode = 200,
            data = null;

        let promise = new Promise(function (resolve, reject) {
            let xhr = new XMLHttpRequest();

            // let req = verb + " " + url;
            // if (data !== undefined && data !== null) {
            //     req += ("\n" + JSON.stringify(data, null, 2));
            // }
            xhr.open(verb, url, true);
            xhr.setRequestHeader("Content-type", "application/json");
            try {
                if (data === undefined || data === null) {
                    xhr.send();
                } else {
                    xhr.send(JSON.stringify(data));
                }
            } catch (err) {
                console.log("Send Error ", err);
            }

            let requestTimer = setTimeout(() => {
                xhr.abort();
                let mess = {code: 408, message: 'Timeout'};
                reject(mess);
            }, TIMEOUT);

            xhr.onload = () => {
                clearTimeout(requestTimer);
                if (xhr.status === happyCode) {
                    resolve(xhr.response);
                } else {
                    reject({code: xhr.status, message: xhr.response});
                }
            };
        });
        return promise;
    }

    function fetch() {
        let getData = getNMEAData();
        getData.then((value) => {
            //  console.log("Done:", value);
            let json = JSON.parse(value);
            onMessage(json);
        }, (error, errmess) => {
            let message;
            if (errmess !== undefined) {
                try {
                    let mess = JSON.parse(errmess);
                    if (mess.message !== undefined) {
                        message = mess.message;
                    }
                } catch (err) {
                    //  console.log(errmess);
                }
            }
            console.log("Failed to get nmea data..." + (error !== undefined ? JSON.stringify(error) : ' - ') + ', ' + (message !== undefined ? message : ' - '));
        });

    }

    let betweenPing = 5000;
    (() => {
        // Long poll for NMEA/AIS
        setInterval(() => {
            fetch();
        }, betweenPing);

    })();
</script>
</html>
